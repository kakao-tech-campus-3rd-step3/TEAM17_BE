<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="isEdit=${packId != null}">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${isEdit} ? '패키지 수정' : '패키지 등록'">패키지 등록/수정</title>
  <link rel="stylesheet" th:href="@{/css/admin-style.css}" />
  <style>
    :root { --primary:#4F46E5; --muted:#f6f7fb; --danger:#dc2626; --border:#e5e7eb; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; background:#fff; color:#111827; }
    .container{ max-width:1100px; margin:32px auto; padding:0 16px; }
    .titlebar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .title{ font-size:22px; font-weight:800; margin:0; }
    .tag{ padding:3px 10px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,.04); }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .field{ margin-bottom:14px; }
    label{ font-weight:600; display:block; margin-bottom:6px; }
    input[type="text"], input[type="number"], select, textarea{
      width:100%; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; background:#fff;
    }
    textarea{ min-height:120px; resize:vertical; }
    .error{ color:var(--danger); font-size:12px; margin-top:6px; }
    .invalid{ border-color: var(--danger) !important; background:#FEF2F2; }
    .btnbar{ display:flex; gap:8px; margin-top:18px; }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    .btn-danger{ background:#fff; color:#b91c1c; border-color:#fecaca; }
    .muted{ color:#6b7280; }
    .small{ font-size:12px; }
    .list{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff; }
    .list-header{ display:flex; gap:10px; align-items:center; padding:10px 12px; background:#fafafa; border-bottom:1px solid var(--border); }
    .list-body{ max-height:420px; overflow:auto; }
    .row{ display:grid; grid-template-columns: 1fr 120px 90px; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border); }
    .row:last-child{ border-bottom:none; }
    .row .price{ text-align:right; font-variant-numeric: tabular-nums; }
    .row .actions{ text-align:right; }
    .search{ flex:1; }
    .image-preview{ width:260px; aspect-ratio:16/10; background:#f9fafb; border:1px dashed var(--border); border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .image-preview img{ width:100%; height:100%; object-fit:cover; }
    .basket-summary{ display:flex; justify-content:space-between; padding:10px 12px; background:#fafafa; border-top:1px solid var(--border); }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#F1F5F9; font-size:12px; }
  </style>
</head>
<body>

<div class="admin-shell">
  <!-- ★ 현재 템플릿 이름을 fragment 인자로 전달 -->
  <div th:replace="~{admin/fragments/sidebar :: sidebar(${#execInfo.templateName})}"></div>

  <main class="admin-content">
    <div class="container">
      <div class="titlebar">
        <h1 class="title" th:text="${isEdit} ? '패키지 수정' : '패키지 등록'">패키지 등록/수정</h1>
        <span class="tag" th:text="${isEdit} ? 'UPDATE' : 'CREATE'">CREATE</span>
      </div>

      <div class="card">
        <form th:action="${isEdit} ? @{/admin/packs/{id}/edit(id=${packId})} : @{/admin/packs/add}"
              th:object="${packDto}" method="post" onsubmit="return beforeSubmit();">
          <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <input type="hidden" name="id" th:value="${packId}"/>

          <div class="grid-2">
            <div>
              <div class="field">
                <label for="name">패키지 이름</label>
                <input type="text" id="name" th:field="*{name}" th:classappend="${#fields.hasErrors('name')} ? 'invalid'"/>
                <div class="error" th:errors="*{name}"></div>
              </div>

              <div class="field">
                <label for="categoryId">카테고리</label>
                <select id="categoryId" th:field="*{categoryId}" th:classappend="${#fields.hasErrors('categoryId')} ? 'invalid'">
                  <option value="">-- 카테고리 선택 --</option>
                  <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
                <div class="error" th:errors="*{categoryId}"></div>
              </div>

              <div class="field">
                <label for="totalCost">총 비용</label>
                <div style="display:flex; gap:8px;">
                  <input type="number" id="totalCost" th:field="*{totalCost}" step="1" th:classappend="${#fields.hasErrors('totalCost')} ? 'invalid'"/>
                  <button type="button" class="btn" onclick="fillCostBySum()">선택 합계로 채우기</button>
                </div>
                <div class="error" th:errors="*{totalCost}"></div>
                <div class="small muted">※ 합계로 채운 뒤 필요하면 직접 수정하세요.</div>
              </div>

              <div class="field">
                <label for="src">대표 이미지 URL</label>
                <input type="text" id="src" th:field="*{src}" placeholder="https://..." oninput="previewImage()"
                       th:classappend="${#fields.hasErrors('src')} ? 'invalid'"/>
                <div class="error" th:errors="*{src}"></div>
                <div class="image-preview" id="imagePreview" style="margin-top:8px;"><span class="small muted">미리보기</span></div>
              </div>

              <div class="field">
                <label for="description">설명</label>
                <textarea id="description" th:field="*{description}" th:classappend="${#fields.hasErrors('description')} ? 'invalid'"></textarea>
                <div class="error" th:errors="*{description}"></div>
              </div>
            </div>

            <div>
              <div class="list" style="margin-bottom:16px;">
                <div class="list-header">
                  <strong>상품 목록</strong>
                  <input type="text" class="search" id="productFilter" placeholder="상품 검색(이름/가격)" oninput="filterProducts()"/>
                  <span class="pill small" id="allCount"></span>
                </div>
                <div class="list-body" id="productList">
                  <div class="row"
                       th:each="p : ${products}"
                       th:attr="data-id=${p.id}, data-name=${p.name}, data-price=${p.cost}">
                    <div th:text="${p.name}">상품명</div>
                    <div class="price" th:text="${p.cost}">0</div>
                    <div class="actions">
                      <button type="button" class="btn" th:attr="data-id=${p.id}" onclick="addToCart(this)">추가</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="list">
                <div class="list-header">
                  <strong>선택한 상품</strong>
                  <span class="pill small" id="selCount">0개</span>
                </div>
                <div class="list-body" id="cartList"></div>
                <div class="basket-summary">
                  <div class="small muted">※ 동일 상품은 중복 추가되지 않습니다.</div>
                  <div><b>합계:</b> <span id="sumPrice">0</span></div>
                </div>
              </div>

              <div id="hiddenInputs"></div>
              <div class="small muted" style="margin-top:8px;">폼 제출 시 선택한 상품들의 ID가 <code>productIds</code>로 전송됩니다.</div>
            </div>
          </div>

          <div class="btnbar">
            <button id="submitBtn" type="submit" class="btn btn-primary">저장</button>
            <a th:href="@{/admin/packs}" class="btn">취소</a>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>

<script th:inline="javascript">
  const presetIds = /*[[${packDto.productIds}]]*/ [];
  const $productList = document.getElementById('productList');
  const $cartList    = document.getElementById('cartList');
  const $hidden      = document.getElementById('hiddenInputs');
  const $sumPrice    = document.getElementById('sumPrice');
  const $selCount    = document.getElementById('selCount');
  const $allCount    = document.getElementById('allCount');
  const $filter      = document.getElementById('productFilter');
  const $totalCost   = document.getElementById('totalCost');
  const $src         = document.getElementById('src');
  const $imagePreview= document.getElementById('imagePreview');

  function formatInt(n){ return Number(n||0); }
  function readRow(el){ return { id:formatInt(el.getAttribute('data-id')), name:el.getAttribute('data-name'), price:formatInt(el.getAttribute('data-price')) }; }
  function cartHas(id){ return !!$cartList.querySelector(`[data-id="${id}"]`); }
  function updateHiddenInputs(){
    $hidden.innerHTML = '';
    const ids = Array.from($cartList.querySelectorAll('.row')).map(r => r.getAttribute('data-id'));
    ids.forEach(id => { const i=document.createElement('input'); i.type='hidden'; i.name='productIds'; i.value=id; $hidden.appendChild(i); });
    $selCount.textContent = ids.length + '개';
  }
  function updateSum(){ const sum = Array.from($cartList.querySelectorAll('.row')).reduce((a,r)=>a+formatInt(r.getAttribute('data-price')),0); $sumPrice.textContent = sum; }
  function disableAddButton(id, d){ const btn=$productList.querySelector(`button[data-id="${id}"]`); if(!btn) return; btn.disabled=!!d; btn.textContent=d?'추가됨':'추가'; }
  function addToCart(btn){
    const row=btn.closest('.row'); const item=readRow(row); if(cartHas(item.id)) return;
    const el=document.createElement('div'); el.className='row'; el.setAttribute('data-id',item.id); el.setAttribute('data-name',item.name); el.setAttribute('data-price',item.price);
    el.innerHTML=`<div>${item.name}</div><div class="price">${item.price}</div><div class="actions"><button type="button" class="btn btn-danger" onclick="removeFromCart(${item.id})">제거</button></div>`;
    $cartList.appendChild(el); disableAddButton(item.id,true); updateHiddenInputs(); updateSum();
  }
  function removeFromCart(id){ const el=$cartList.querySelector(`.row[data-id="${id}"]`); if(el) el.remove(); disableAddButton(id,false); updateHiddenInputs(); updateSum(); }
  function filterProducts(){ const q=($filter.value||'').toLowerCase().trim(); $productList.querySelectorAll('.row').forEach(r=>{const n=(r.getAttribute('data-name')||'').toLowerCase(); const p=(r.getAttribute('data-price')||'').toString(); r.style.display=(n.includes(q)||p.includes(q))?'':'none';}); }
  function fillCostBySum(){ const sum=Array.from($cartList.querySelectorAll('.row')).reduce((a,r)=>a+formatInt(r.getAttribute('data-price')),0); if(!isNaN(sum)&&$totalCost){$totalCost.value=sum;} }
  function previewImage(){ const url=$src&&$src.value&&$src.value.trim(); if(!url){ $imagePreview.innerHTML='<span class="small muted">미리보기</span>'; return;} const img=new Image(); img.onload=()=>{$imagePreview.innerHTML=''; $imagePreview.appendChild(img);}; img.onerror=()=>{$imagePreview.innerHTML='<span class="error small">이미지를 불러올 수 없습니다.</span>';}; img.src=url; }
  function beforeSubmit(){ const b=document.getElementById('submitBtn'); if(b){ b.disabled=true; b.textContent='저장 중...'; } return true; }
  (function init(){ $allCount.textContent = ($productList.querySelectorAll('.row').length) + '개';
    if(Array.isArray(presetIds)){ presetIds.forEach(id=>{ const row=$productList.querySelector(`.row[data-id="${id}"]`); if(row){ const btn=row.querySelector('button[data-id]'); if(btn) addToCart(btn); } }); }
    previewImage();
  })();
</script>
</body>
</html>
