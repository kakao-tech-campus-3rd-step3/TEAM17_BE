<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="isEdit=${packId != null}">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${isEdit} ? '패키지 수정' : '패키지 등록'">패키지 등록/수정</title>
  <link rel="stylesheet" th:href="@{/css/admin-style.css}" />
  <style>
    :root { --primary:#4F46E5; --muted:#f6f7fb; --danger:#dc2626; --border:#e5e7eb; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; background:#fff; color:#111827; }
    .container{ max-width:1100px; margin:32px auto; padding:0 16px; }
    .titlebar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .title{ font-size:22px; font-weight:800; margin:0; }
    .tag{ padding:3px 10px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,.04); }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .field{ margin-bottom:14px; }
    label{ font-weight:600; display:block; margin-bottom:6px; }
    input[type="text"], input[type="number"], select, textarea{
      width:100%; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; background:#fff;
    }
    textarea{ min-height:120px; resize:vertical; }
    .error{ color:var(--danger); font-size:12px; margin-top:6px; }
    .invalid{ border-color: var(--danger) !important; background:#FEF2F2; }
    .btnbar{ display:flex; gap:8px; margin-top:18px; }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    .btn-danger{ background:#dc2626; color:#fff; border-color:#dc2626; }
    .muted{ color:#6b7280; }
    .small{ font-size:12px; }
    .image-preview{ width:260px; aspect-ratio:16/10; background:#f9fafb; border:1px dashed var(--border); border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .image-preview img{ width:100%; height:100%; object-fit:cover; }

    /* PackItem 관리 영역 */
    .items-section{ border:1px solid var(--border); border-radius:12px; padding:16px; background:#fafafa; }
    .items-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .item-card{
      background:#fff; border:1px solid var(--border); border-radius:10px;
      padding:12px; margin-bottom:10px; position:relative;
    }
    .item-card:last-child{ margin-bottom:0; }
    .item-remove{
      position:absolute; top:8px; right:8px;
      background:#dc2626; color:#fff; border:none; border-radius:6px;
      padding:4px 8px; cursor:pointer; font-size:11px;
    }
    .item-field{ margin-bottom:8px; }
    .item-field:last-child{ margin-bottom:0; }
    .item-field label{ font-size:12px; font-weight:600; color:#6b7280; margin-bottom:4px; }
    .item-field input{ font-size:13px; padding:8px 10px; }
    .item-preview{
      width:100%; height:80px; background:#f9fafb;
      border:1px dashed var(--border); border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; margin-top:4px;
    }
    .item-preview img{ width:100%; height:100%; object-fit:cover; }
  </style>
</head>
<body>

<div class="admin-shell">
  <div th:replace="~{admin/fragments/sidebar :: sidebar(${#execInfo.templateName})}"></div>

  <main class="admin-content">
    <div class="container">
      <div class="titlebar">
        <h1 class="title" th:text="${isEdit} ? '패키지 수정' : '패키지 등록'">패키지 등록/수정</h1>
        <span class="tag" th:text="${isEdit} ? 'UPDATE' : 'CREATE'">CREATE</span>
      </div>

      <div class="card">
        <form th:action="${isEdit} ? @{/admin/packs/{id}/edit(id=${packId})} : @{/admin/packs/add}"
              th:object="${packDto}" method="post" onsubmit="return beforeSubmit();">
          <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <input type="hidden" name="id" th:value="${packId}"/>

          <div class="grid-2">
            <!-- 좌측: 기본 정보 -->
            <div>
              <div class="field">
                <label for="name">패키지 이름 *</label>
                <input type="text" id="name" th:field="*{name}" th:classappend="${#fields.hasErrors('name')} ? 'invalid'" required/>
                <div class="error" th:errors="*{name}"></div>
              </div>

              <div class="field">
                <label for="categoryId">카테고리 *</label>
                <select id="categoryId" th:field="*{categoryId}" th:classappend="${#fields.hasErrors('categoryId')} ? 'invalid'" required>
                  <option value="">-- 카테고리 선택 --</option>
                  <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
                <div class="error" th:errors="*{categoryId}"></div>
              </div>

              <div class="field">
                <label for="price">전체 가격</label>
                <input type="number" id="price" th:field="*{price}" step="1" min="0" th:classappend="${#fields.hasErrors('price')} ? 'invalid'"/>
                <div class="error" th:errors="*{price}"></div>
                <div class="small muted">※ 팩 전체의 대략적인 가격을 입력하세요.</div>
              </div>

              <div class="field">
                <label for="mainImageUrl">대표 이미지 URL</label>
                <input type="text" id="mainImageUrl" th:field="*{mainImageUrl}" placeholder="https://..." oninput="previewMainImage()"
                       th:classappend="${#fields.hasErrors('mainImageUrl')} ? 'invalid'"/>
                <div class="error" th:errors="*{mainImageUrl}"></div>
                <div class="image-preview" id="mainImagePreview" style="margin-top:8px;">
                  <span class="small muted">미리보기</span>
                </div>
              </div>

              <div class="field">
                <label for="description">설명</label>
                <textarea id="description" th:field="*{description}" th:classappend="${#fields.hasErrors('description')} ? 'invalid'"></textarea>
                <div class="error" th:errors="*{description}"></div>
              </div>

              <div class="field">
                <label for="hashtagNames">해시태그 (쉼표로 구분)</label>
                <input type="text" id="hashtagNames" name="hashtagNames" 
                       th:value="${isEdit ? (#strings.listJoin(packDto.hashtagNames, ', ')) : ''}" 
                       th:classappend="${#fields.hasErrors('hashtagNames')} ? 'invalid'"
                       placeholder="예: 해시태그1, 해시태그2, 해시태그3"/>
                <div class="error" th:errors="*{hashtagNames}"></div>
                <div class="small muted">최대 10개까지 가능합니다.</div>
              </div>
            </div>

            <!-- 우측: PackItem 관리 -->
            <div>
              <div class="items-section">
                <div class="items-header">
                  <strong>팩 구성 아이템 *</strong>
                  <button type="button" class="btn btn-primary" onclick="addItem()">+ 아이템 추가</button>
                </div>

                <div id="itemsContainer">
                  <!-- 기존 아이템들 (수정 모드일 때) -->
                  <div th:each="item, stat : *{items}" class="item-card">
                    <button type="button" class="item-remove" onclick="removeItem(this)">삭제</button>

                    <div class="item-field">
                      <label th:for="'item-name-' + ${stat.index}">아이템 이름 *</label>
                      <input type="text"
                             th:id="'item-name-' + ${stat.index}"
                             th:name="'items[' + ${stat.index} + '].name'"
                             th:value="${item.name}"
                             placeholder="예: 스마트폰 짐벌"
                             required/>
                    </div>

                    <div class="item-field">
                      <label th:for="'item-link-' + ${stat.index}">링크 URL</label>
                      <input type="text"
                             th:id="'item-link-' + ${stat.index}"
                             th:name="'items[' + ${stat.index} + '].linkUrl'"
                             th:value="${item.linkUrl}"
                             placeholder="https://example.com/product"/>
                    </div>

                    <div class="item-field">
                      <label th:for="'item-desc-' + ${stat.index}">설명</label>
                      <textarea th:id="'item-desc-' + ${stat.index}"
                                th:name="'items[' + ${stat.index} + '].description'"
                                th:text="${item.description}"
                                placeholder="아이템 설명"
                                rows="2"></textarea>
                    </div>

                    <div class="item-field">
                      <label th:for="'item-img-' + ${stat.index}">이미지 URL</label>
                      <input type="text"
                             th:id="'item-img-' + ${stat.index}"
                             th:name="'items[' + ${stat.index} + '].imageUrl'"
                             th:value="${item.imageUrl}"
                             placeholder="https://..."
                             th:oninput="'previewItemImage(this, ' + ${stat.index} + ')'"/>
                      <div th:id="'item-preview-' + ${stat.index}" class="item-preview">
                        <span class="small muted">미리보기</span>
                      </div>
                    </div>
                  </div>

                  <!-- 신규 아이템이 동적으로 추가될 영역 -->
                </div>

                <div class="small muted" style="margin-top:12px;">
                  ※ 최소 1개 이상의 아이템이 필요합니다.
                </div>
              </div>
            </div>
          </div>

          <div class="btnbar">
            <button id="submitBtn" type="submit" class="btn btn-primary">저장</button>
            <a th:href="@{/admin/packs}" class="btn">취소</a>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>

<script th:inline="javascript">
  let itemIndex = /*[[${packDto.items != null ? #lists.size(packDto.items) : 0}]]*/ 0;

  // 대표 이미지 미리보기
  function previewMainImage() {
    const url = document.getElementById('mainImageUrl')?.value?.trim();
    const preview = document.getElementById('mainImagePreview');
    if (!url) {
      preview.innerHTML = '<span class="small muted">미리보기</span>';
      return;
    }
    const img = new Image();
    img.onload = () => {
      preview.innerHTML = '';
      preview.appendChild(img);
    };
    img.onerror = () => {
      preview.innerHTML = '<span class="error small">이미지를 불러올 수 없습니다.</span>';
    };
    img.src = url;
  }

  // 아이템 이미지 미리보기
  function previewItemImage(input, index) {
    const url = input.value?.trim();
    const preview = document.getElementById('item-preview-' + index);
    if (!preview) return;

    if (!url) {
      preview.innerHTML = '<span class="small muted">미리보기</span>';
      return;
    }
    const img = new Image();
    img.onload = () => {
      preview.innerHTML = '';
      preview.appendChild(img);
    };
    img.onerror = () => {
      preview.innerHTML = '<span class="error small">이미지 로드 실패</span>';
    };
    img.src = url;
  }

  // 새 아이템 추가
  function addItem() {
    const container = document.getElementById('itemsContainer');
    const itemCard = document.createElement('div');
    itemCard.className = 'item-card';
    itemCard.innerHTML = `
      <button type="button" class="item-remove" onclick="removeItem(this)">삭제</button>

      <div class="item-field">
        <label for="item-name-${itemIndex}">아이템 이름 *</label>
        <input type="text" id="item-name-${itemIndex}" name="items[${itemIndex}].name" placeholder="예: 스마트폰 짐벌" required/>
      </div>

      <div class="item-field">
        <label for="item-link-${itemIndex}">링크 URL</label>
        <input type="text" id="item-link-${itemIndex}" name="items[${itemIndex}].linkUrl" placeholder="https://example.com/product"/>
      </div>

      <div class="item-field">
        <label for="item-desc-${itemIndex}">설명</label>
        <textarea id="item-desc-${itemIndex}" name="items[${itemIndex}].description" placeholder="아이템 설명" rows="2"></textarea>
      </div>

      <div class="item-field">
        <label for="item-img-${itemIndex}">이미지 URL</label>
        <input type="text" id="item-img-${itemIndex}" name="items[${itemIndex}].imageUrl" placeholder="https://..." oninput="previewItemImage(this, ${itemIndex})"/>
        <div id="item-preview-${itemIndex}" class="item-preview">
          <span class="small muted">미리보기</span>
        </div>
      </div>
    `;
    container.appendChild(itemCard);
    itemIndex++;
  }

  // 아이템 삭제
  function removeItem(button) {
    const itemCard = button.closest('.item-card');
    if (itemCard) {
      // 최소 1개는 남겨야 함
      const container = document.getElementById('itemsContainer');
      const remainingItems = container.querySelectorAll('.item-card');
      if (remainingItems.length <= 1) {
        alert('최소 1개의 아이템이 필요합니다.');
        return;
      }
      itemCard.remove();
      reindexItems();
    }
  }

  // 인덱스 재정렬 함수 추가
  function reindexItems() {
    const container = document.getElementById('itemsContainer');
    const items = container.querySelectorAll('.item-card');

    items.forEach((item, newIndex) => {
      // name 속성 업데이트
      item.querySelectorAll('input, textarea').forEach(field => {
        const name = field.getAttribute('name');
        if (name && name.startsWith('items[')) {
          const newName = name.replace(/items\[\d+\]/, `items[${newIndex}]`);
          field.setAttribute('name', newName);
        }
      });

      // id 속성 업데이트 (미리보기용)
      const previewDiv = item.querySelector('[id^="item-preview-"]');
      if (previewDiv) {
        previewDiv.setAttribute('id', `item-preview-${newIndex}`);
      }
    });
  }

  // 폼 제출 전 검증
  function beforeSubmit() {
    reindexItems();

    const container = document.getElementById('itemsContainer');
    const items = container.querySelectorAll('.item-card');

    if (items.length === 0) {
      alert('최소 1개 이상의 아이템을 추가해주세요.');
      return false;
    }

    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = '저장 중...';
    }
    return true;
  }

  // 초기화
  (function init() {
    previewMainImage();

    // 기존 아이템 이미지 미리보기 (수정 모드)
    const existingItems = document.querySelectorAll('.item-card input[name$=".imageUrl"]');
    existingItems.forEach((input, idx) => {
      if (input.value) {
        previewItemImage(input, idx);
      }
    });
  })();
</script>
</body>
</html>
