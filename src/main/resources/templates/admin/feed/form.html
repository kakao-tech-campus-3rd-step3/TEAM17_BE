<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="isEdit=${feedId != null}">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${isEdit} ? 'Feed ìˆ˜ì •' : 'Feed ë“±ë¡'">Feed ë“±ë¡/ìˆ˜ì •</title>
  <link rel="stylesheet" th:href="@{/css/admin-style.css}"/>
  <link rel="stylesheet" th:href="@{/css/feed-style.css}" />
</head>
<body>
<div class="admin-shell">
  <div th:replace="~{admin/fragments/sidebar :: sidebar(${#execInfo.templateName})}"></div>

  <main class="admin-content">
    <div class="container">
      <div class="titlebar">
        <h1 class="title" th:text="${isEdit} ? 'Feed ìˆ˜ì •' : 'Feed ë“±ë¡'">Feed ë“±ë¡/ìˆ˜ì •</h1>
        <span class="tag" th:text="${isEdit} ? 'UPDATE' : 'CREATE'">CREATE</span>
      </div>

      <div class="card">
        <form method="post" th:attr="action=${isEdit ? '/admin/feeds/' + feedId + '/edit' : '/admin/feeds/add'}">
          <div class="field">
            <label for="description">ì„¤ëª…</label>
            <textarea id="description" name="description" th:text="${isEdit ? feed.description : ''}" placeholder="Feed ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          </div>

          <div class="field">
            <label for="imageUrl">ì´ë¯¸ì§€ URL</label>
            <input type="url" id="imageUrl" name="imageUrl" th:value="${isEdit ? feed.imageUrl : ''}" placeholder="https://example.com/image.jpg"/>
          </div>

          <div class="field" th:unless="${isEdit}">
            <label for="feedType">í”¼ë“œ íƒ€ì…</label>
            <select id="feedType" name="feedType" onchange="toggleProductSection()">
              <option value="">-- í”¼ë“œ íƒ€ì… ì„ íƒ --</option>
              <option th:each="type : ${feedTypes}" th:value="${type}" th:text="${type}"></option>
            </select>
          </div>

          <div id="productSection" style="display:none;" th:unless="${isEdit}">
            <div class="field">
              <label>ì—°ê´€ ìƒí’ˆ</label>
              <div id="productList"></div>
              <button type="button" onclick="addProduct()" class="btn btn-ghost add-product-btn">ìƒí’ˆ ì¶”ê°€</button>
            </div>
          </div>

          <div th:if="${isEdit and feed.feedType.toString() == 'INFO' and !#lists.isEmpty(feed.feedProducts)}">
            <div class="field">
              <label>ì—°ê´€ ìƒí’ˆ (ìˆ˜ì • ë¶ˆê°€)</label>
              <div th:each="feedProduct : ${feed.feedProducts}" class="readonly-product">
                <div class="readonly-product-name" th:text="${feedProduct.product.name}">ìƒí’ˆëª…</div>
                <div class="readonly-product-desc" th:text="${feedProduct.description}">ìƒí’ˆ ì„¤ëª…</div>
              </div>
              <div class="info-text">
                ğŸ’¡ ìƒí’ˆ ì •ë³´ ìˆ˜ì •ì€ ë³„ë„ ìƒí’ˆ ê´€ë¦¬ì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”.
              </div>
            </div>
          </div>

          <div class="field">
            <label for="categoryId">ì¹´í…Œê³ ë¦¬</label>
            <select id="categoryId" name="categoryId">
              <option value="">-- ì¹´í…Œê³ ë¦¬ ì„ íƒ --</option>
              <option th:each="category : ${categories}"
                      th:value="${category.id}"
                      th:text="${category.name}"
                      th:selected="${isEdit and feed.category != null and feed.category.id == category.id}"></option>
            </select>
          </div>

          <div class="field" th:unless="${isEdit}">
            <label for="userId">ì‘ì„±ì</label>
            <select id="userId" name="userId">
              <option value="">-- ì‘ì„±ì ì„ íƒ --</option>
              <option th:each="member : ${members}" th:value="${member.userId}" th:text="${member.email}"></option>
            </select>
          </div>

          <div class="btnbar">
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
            <a th:href="@{/admin/feeds}" class="btn">ì·¨ì†Œ</a>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>


<template id="product-item-template">
  <div class="product-item">
    <div class="product-item-header">
      <strong class="product-title">ìƒí’ˆ</strong>
      <button type="button" class="remove-product-btn">ì‚­ì œ</button>
    </div>
    <div class="product-fields">
      <input type="text" class="product-name" placeholder="ìƒí’ˆëª…" required>
      <input type="url" class="product-image-url" placeholder="ìƒí’ˆ ì´ë¯¸ì§€ URL">
      <textarea class="product-description" placeholder="ìƒí’ˆ ì„¤ëª…" rows="2"></textarea>
    </div>
  </div>
</template>


<script th:if="${!isEdit}">
  function toggleProductSection() {
    const feedType = document.getElementById('feedType').value;
    const productSection = document.getElementById('productSection');

    if (feedType === 'INFO') {
      productSection.style.display = 'block';
    } else {
      productSection.style.display = 'none';
      document.getElementById('productList').innerHTML = '';
    }
  }

  function addProduct() {
    const template = document.getElementById('product-item-template');
    const productList = document.getElementById('productList');
    const productIndex = productList.children.length;

    const clone = template.content.cloneNode(true);

    const title = clone.querySelector('.product-title');
    const nameInput = clone.querySelector('.product-name');
    const imageUrlInput = clone.querySelector('.product-image-url');
    const descriptionTextarea = clone.querySelector('.product-description');

    title.textContent = `ìƒí’ˆ ${productIndex + 1}`;
    nameInput.name = `products[${productIndex}].name`;
    imageUrlInput.name = `products[${productIndex}].imageUrl`;
    descriptionTextarea.name = `products[${productIndex}].description`;

    productList.appendChild(clone);
  }

  function reindexProducts() {
    const productItems = document.querySelectorAll('.product-item');
    productItems.forEach((item, index) => {
      const title = item.querySelector('.product-title');
      title.textContent = `ìƒí’ˆ ${index + 1}`;

      const nameInput = item.querySelector('.product-name');
      const imageInput = item.querySelector('.product-image-url');
      const descTextarea = item.querySelector('.product-description');

      if (nameInput) nameInput.name = `products[${index}].name`;
      if (imageInput) imageInput.name = `products[${index}].imageUrl`;
      if (descTextarea) descTextarea.name = `products[${index}].description`;
    });
  }

  const productListContainer = document.getElementById('productList');
  productListContainer.addEventListener('click', function (event) {
    if (event.target.classList.contains('remove-product-btn')) {
      const productItem = event.target.closest('.product-item');
      if (productItem) {
        productItem.remove();
        reindexProducts();
      }
    }
  });
</script>

</body>
</html>
