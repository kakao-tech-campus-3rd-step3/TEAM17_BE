<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="isEdit=${feedId != null}">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${isEdit} ? 'Feed 수정' : 'Feed 등록'">Feed 등록/수정</title>
  <link rel="stylesheet" th:href="@{/css/admin-style.css}"/>
  <link rel="stylesheet" th:href="@{/css/feed-style.css}" />
</head>
<body>
<div class="admin-shell">
  <div th:replace="~{admin/fragments/sidebar :: sidebar(${#execInfo.templateName})}"></div>

  <main class="admin-content">
    <div class="container">
      <div class="titlebar">
        <h1 class="title" th:text="${isEdit} ? 'Feed 수정' : 'Feed 등록'">Feed 등록/수정</h1>
        <span class="tag" th:text="${isEdit} ? 'UPDATE' : 'CREATE'">CREATE</span>
      </div>

      <div class="card">
        <form method="post" th:attr="action=${isEdit ? '/admin/feeds/' + feedId + '/edit' : '/admin/feeds/add'}">
          <div class="field">
            <label for="description">설명</label>
            <textarea id="description" name="description" th:text="${isEdit ? feed.description : ''}" placeholder="Feed 설명을 입력하세요"></textarea>
          </div>

          <div class="field">
            <label for="imageUrl">이미지 URL</label>
            <input type="url" id="imageUrl" name="imageUrl" th:value="${isEdit ? feed.imageUrl : ''}" placeholder="https://example.com/image.jpg"/>
          </div>

          <div class="field" th:unless="${isEdit}">
            <label for="feedType">피드 타입</label>
            <select id="feedType" name="feedType" onchange="toggleProductSection()">
              <option value="">-- 피드 타입 선택 --</option>
              <option th:each="type : ${feedTypes}" th:value="${type}" th:text="${type}"></option>
            </select>
          </div>

          <div id="productSection" style="display:none;" th:unless="${isEdit}">
            <div class="field">
              <label>연관 상품</label>
              <div id="productList"></div>
              <button type="button" onclick="addProduct()" class="btn btn-ghost add-product-btn">상품 추가</button>
            </div>
          </div>

          <div th:if="${isEdit and feed.feedType.toString() == 'INFO' and !#lists.isEmpty(feed.feedProducts)}">
            <div class="field">
              <label>연관 상품 (수정 불가)</label>
              <div th:each="feedProduct : ${feed.feedProducts}" class="readonly-product">
                <div class="readonly-product-name" th:text="${feedProduct.product.name}">상품명</div>
                <div class="readonly-product-desc" th:text="${feedProduct.description}">상품 설명</div>
              </div>
              <div class="info-text">
                💡 상품 정보 수정은 별도 상품 관리에서 진행해주세요.
              </div>
            </div>
          </div>

          <div class="field">
            <label for="categoryId">카테고리</label>
            <select id="categoryId" name="categoryId">
              <option value="">-- 카테고리 선택 --</option>
              <option th:each="category : ${categories}"
                      th:value="${category.id}"
                      th:text="${category.name}"
                      th:selected="${isEdit and feed.category != null and feed.category.id == category.id}"></option>
            </select>
          </div>

          <div class="field" th:unless="${isEdit}">
            <label for="userId">작성자</label>
            <select id="userId" name="userId">
              <option value="">-- 작성자 선택 --</option>
              <option th:each="member : ${members}" th:value="${member.userId}" th:text="${member.email}"></option>
            </select>
          </div>

          <div class="btnbar">
            <button type="submit" class="btn btn-primary">저장</button>
            <a th:href="@{/admin/feeds}" class="btn">취소</a>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>


<template id="product-item-template">
  <div class="product-item">
    <div class="product-item-header">
      <strong class="product-title">상품</strong>
      <button type="button" class="remove-product-btn">삭제</button>
    </div>
    <div class="product-fields">
      <input type="text" class="product-name" placeholder="상품명" required>
      <input type="url" class="product-image-url" placeholder="상품 이미지 URL">
      <textarea class="product-description" placeholder="상품 설명" rows="2"></textarea>
    </div>
  </div>
</template>


<script th:if="${!isEdit}">
  function toggleProductSection() {
    const feedType = document.getElementById('feedType').value;
    const productSection = document.getElementById('productSection');

    if (feedType === 'INFO') {
      productSection.style.display = 'block';
    } else {
      productSection.style.display = 'none';
      document.getElementById('productList').innerHTML = '';
    }
  }

  function addProduct() {
    const template = document.getElementById('product-item-template');
    const productList = document.getElementById('productList');
    const productIndex = productList.children.length;

    const clone = template.content.cloneNode(true);

    const title = clone.querySelector('.product-title');
    const nameInput = clone.querySelector('.product-name');
    const imageUrlInput = clone.querySelector('.product-image-url');
    const descriptionTextarea = clone.querySelector('.product-description');

    title.textContent = `상품 ${productIndex + 1}`;
    nameInput.name = `products[${productIndex}].name`;
    imageUrlInput.name = `products[${productIndex}].imageUrl`;
    descriptionTextarea.name = `products[${productIndex}].description`;

    productList.appendChild(clone);
  }

  function reindexProducts() {
    const productItems = document.querySelectorAll('.product-item');
    productItems.forEach((item, index) => {
      const title = item.querySelector('.product-title');
      title.textContent = `상품 ${index + 1}`;

      const nameInput = item.querySelector('.product-name');
      const imageInput = item.querySelector('.product-image-url');
      const descTextarea = item.querySelector('.product-description');

      if (nameInput) nameInput.name = `products[${index}].name`;
      if (imageInput) imageInput.name = `products[${index}].imageUrl`;
      if (descTextarea) descTextarea.name = `products[${index}].description`;
    });
  }

  const productListContainer = document.getElementById('productList');
  productListContainer.addEventListener('click', function (event) {
    if (event.target.classList.contains('remove-product-btn')) {
      const productItem = event.target.closest('.product-item');
      if (productItem) {
        productItem.remove();
        reindexProducts();
      }
    }
  });
</script>

</body>
</html>
