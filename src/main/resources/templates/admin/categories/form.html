<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="isEdit=${category.id != null}">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${isEdit} ? '카테고리 수정' : '카테고리 등록'">카테고리 등록/수정</title>
  <link rel="stylesheet" th:href="@{/css/admin-style.css}" />
  <style>
    :root { --primary:#4F46E5; --muted:#f6f7fb; --danger:#dc2626; --border:#e5e7eb; --text:#111827; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; background:#fff; color:var(--text); }
    .container{ max-width:720px; margin:32px auto; padding:0 16px; }
    .titlebar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .title{ font-size:22px; font-weight:800; margin:0; }
    .tag{ padding:3px 10px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,.04); }
    .field{ margin-bottom:14px; }
    label{ font-weight:600; display:block; margin-bottom:6px; }
    input[type="text"]{
      width:100%; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; background:#fff;
    }
    .error{ color:var(--danger); font-size:12px; margin-top:6px; }
    .invalid{ border-color: var(--danger) !important; background:#FEF2F2; }
    .btnbar{ display:flex; gap:8px; margin-top:18px; }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; }
    .btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    .preview{ margin-top:8px; border:1px dashed var(--border); border-radius:12px; background:#f9fafb; display:flex; align-items:center; justify-content:center; overflow:hidden; width:100%; aspect-ratio:16/9; }
    .preview img{ width:100%; height:100%; object-fit:cover; }
  </style>
</head>
<body>
<div class="admin-shell">
  <!-- 사이드바 -->
  <div th:replace="~{admin/fragments/sidebar :: sidebar(${#execInfo.templateName})}"></div>

  <main class="admin-content">
    <div class="container">
      <div class="titlebar">
        <h1 class="title" th:text="${isEdit} ? '카테고리 수정' : '카테고리 등록'">카테고리 등록/수정</h1>
        <span class="tag" th:text="${isEdit} ? 'UPDATE' : 'CREATE'">CREATE</span>
      </div>

      <div class="card">
        <form th:action="${isEdit} ? @{/admin/categories/{id}/edit(id=${category.id})} : @{/admin/categories/add}"
              th:object="${category}" method="post" onsubmit="return beforeSubmit();">

          <input type="hidden" th:field="*{id}"/>
          <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

          <div class="field">
            <label for="name">카테고리 이름</label>
            <input type="text" id="name" th:field="*{name}" required
                   th:classappend="${#fields.hasErrors('name')} ? 'invalid'"/>
            <div class="error" th:errors="*{name}"></div>
          </div>

          <div class="field">
            <label for="src">이미지 주소</label>
            <input type="text" id="src" th:field="*{src}" placeholder="https://..." oninput="previewImage()"
                   th:classappend="${#fields.hasErrors('src')} ? 'invalid'"/>
            <div class="error" th:errors="*{src}"></div>
            <div class="preview" id="imagePreview"><span style="color:#9ca3af;font-size:12px;">미리보기</span></div>
          </div>

          <div class="btnbar">
            <button id="submitBtn" type="submit" class="btn btn-primary">저장</button>
            <a th:href="@{/admin/categories}" class="btn">취소</a>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>

<script th:inline="javascript">
  const $src = document.getElementById('src');
  const $imagePreview = document.getElementById('imagePreview');

  function previewImage(){
    const url = $src && $src.value && $src.value.trim();
    if(!url){ $imagePreview.innerHTML = '<span style="color:#9ca3af;font-size:12px;">미리보기</span>'; return; }
    const img = new Image();
    img.onload = ()=>{ $imagePreview.innerHTML=''; $imagePreview.appendChild(img); };
    img.onerror = ()=>{ $imagePreview.innerHTML='<span class="error">이미지를 불러올 수 없습니다.</span>'; };
    img.src = url;
  }

  function beforeSubmit(){
    const b = document.getElementById('submitBtn');
    if(b){ b.disabled = true; b.textContent = '저장 중...'; }
    return true;
  }

  // 초기 로드 시 미리보기
  (function init(){ previewImage(); })();
</script>
</body>
</html>
